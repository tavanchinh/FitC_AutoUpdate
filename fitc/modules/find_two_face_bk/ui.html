<html>
<head>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; padding: 8px; font-size: 11px; display: flex; flex-direction: column; height: 98vh; margin: 0; background: #f0f0f0; overflow: hidden; }
    .controls { background: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 6px; flex-shrink: 0; }
    .table-container { overflow-y: auto; flex-grow: 1; border: 1px solid #ccc; background: #fff; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th { background: #2c3e50; color: white; position: sticky; top: 0; z-index: 10; padding: 8px; font-size: 13px; font-weight: bold; text-transform: uppercase; }
    td { border: 1px solid #eee; padding: 3px 6px; text-align: left; font-size: 12px; color: #333; }
    .group-header { background: #dfe4ea; font-weight: bold; }
    .group-header td { font-size: 13px; padding: 5px 6px; color: #000; }
    .panel-row:hover { background: #f1f2f6; }
    th:nth-child(1), td:nth-child(1) { width: 40px; text-align: center; }
    th:nth-child(3), td:nth-child(3) { width: 50px; }
    .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .btn-group { display: flex; gap: 4px; margin-top: 6px; }
    .btn { flex: 1; padding: 8px; border: none; cursor: pointer; color: white; font-weight: bold; border-radius: 2px; font-size: 12px; }
    .btn-select { background: #2980b9; }
    .btn-update { background: #e67e22; }
    .btn-restore { background: #7f8c8d; }
    input[type="text"] { width: 100%; padding: 6px; margin-top: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; box-sizing: border-box; }
    #toast { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #27ae60; color: white; padding: 8px 20px; border-radius: 20px; z-index: 100; font-size: 11px; }
  </style>
</head>
<body>
  <div id="toast">Thông báo</div>
  <div class="controls">
    <label><b>Hậu tố màu mới:</b></label>
    <input type="text" id="suffix" value="_2_MAT">
    <div class="btn-group">
      <button class="btn btn-select" onclick="act('select')">Chọn trên 3D</button>
      <button class="btn btn-update" onclick="act('update_mat')">Đổi màu</button>
      <button class="btn btn-restore" onclick="act('restore_mat')">Khôi phục</button>
    </div>
  </div>
  <div class="table-container">
    <table>
      <thead><tr><th>Chọn</th><th>Chi tiết</th><th style="text-align:center;">Dày</th></tr></thead>
      <tbody id="table-body">
        </tbody>
    </table>
  </div>

  <script>
    // 1. Chờ DOM sẵn sàng mới báo cho Ruby
    document.addEventListener("DOMContentLoaded", function() {
      if (window.sketchup) {
        sketchup.ready();
      }
    });

    // 2. Hàm vẽ bảng được gọi từ Ruby
    function renderTable(data) {
      const tbody = document.getElementById('table-body');
      let rowsHtml = "";
      let groupIdx = 0;

      for (const [mat, panels] of Object.entries(data)) {
        const gid = "g_" + groupIdx++;
        rowsHtml += `<tr class='group-header'>
          <td><input type='checkbox' onclick='tgl("${gid}",this.checked)'></td>
          <td colspan='2'>Vật liệu: ${mat}</td>
        </tr>`;
        
        panels.forEach(item => {
          const id = item[0];
          const info = item[1];
          rowsHtml += `<tr class='${gid} panel-row'>
            <td><input type='checkbox' class='chk' value='${id}'></td>
            <td class='truncate' title='${info.name}'>${info.name}</td>
            <td style='text-align:center;'>${info.thickness}</td>
          </tr>`;
        });
      }
      tbody.innerHTML = rowsHtml;
    }

    function tgl(g, c) { 
      document.querySelectorAll('.'+g+' .chk').forEach(cb => cb.checked = c); 
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.innerText = msg; t.style.display = 'block';
      setTimeout(() => { t.style.display = 'none'; }, 2000);
    }

    function act(t) {
      const ids = Array.from(document.querySelectorAll('.chk:checked')).map(c => c.value);
      const s = document.getElementById('suffix').value;
      if(ids.length > 0 && window.sketchup) {
        sketchup.call_ruby(t, ids, s);
      } else {
        alert("Vui lòng chọn tấm!");
      }
    }
  </script>
</body>
</html>